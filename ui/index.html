<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/ui/favicon.ico?v=1">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anomaly Detection - Frontend MVP</title>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --muted:#7f8aa3; --accent:#4ad6b8; --danger:#ff5d5d; --ok:#74d680; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e9eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;line-height:1.6}
    a{color:inherit;text-decoration:none}

    .app-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:18px 24px;border-bottom:1px solid #222;background:linear-gradient(180deg,rgba(19,22,30,0.9),rgba(19,22,30,0.6));position:sticky;top:0;z-index:20}
    .header-main{display:flex;flex-direction:column;gap:4px}
    .header-actions{display:flex;flex-direction:column;align-items:flex-end;gap:6px;text-align:right}
    .nav-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:10px;border:1px solid rgba(74,214,184,0.35);background:rgba(74,214,184,0.12);color:var(--accent);font-size:13px;font-weight:600;transition:background 0.2s ease, transform 0.2s ease}
    .nav-btn:hover{background:rgba(74,214,184,0.24);transform:translateY(-1px)}
    .title-click{cursor:pointer}
    .title-click:hover{color:var(--accent)}
    h1{font-size:22px;margin:0}
    .small-note{font-size:12px;color:var(--muted)}

    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;padding:18px 24px}
    .info-card{background:var(--panel);border:1px solid #1f2330;border-radius:14px;padding:16px 18px;box-shadow:0 12px 28px rgba(0,0,0,0.18)}
    .info-card h3{margin:0 0 10px;font-size:15px;letter-spacing:.01em}
    .step-list{margin:0;padding-left:20px;font-size:13px;color:#c6cede}
    .step-list li{margin-bottom:6px}
    .summary-list{list-style:none;margin:0;padding:0;display:grid;gap:8px}
    .summary-list li{display:flex;justify-content:space-between;gap:12px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);align-items:center}
    .summary-label{color:var(--muted);font-size:12px}
    .summary-value{font-weight:600;font-size:13px;text-align:right}

    .wrap{display:grid;grid-template-columns:minmax(320px,360px) 1fr;gap:16px;padding:0 24px 28px 24px;align-items:start}
    .card{background:var(--panel);border:1px solid #1f2330;border-radius:14px;padding:16px 18px;box-shadow:0 18px 32px rgba(0,0,0,0.18)}
    .card h3{margin-top:0;font-size:16px}
    .row{display:flex;gap:8px;align-items:center}
    input[type=text],input[type=number]{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #333;background:#0e1016;color:#e9eef7;font-size:14px}
    button{padding:9px 14px;border-radius:10px;border:1px solid #2a2f3a;background:#111520;color:#e9eef7;cursor:pointer;font-size:13px;transition:transform 0.1s ease,background 0.2s ease}
    button.primary{background:var(--accent);color:#0b1115;border-color:#2b8f80;font-weight:600}
    button.warn{background:#2b1113;border-color:#61272c;color:#ffc9c9}
    button:hover:not(:disabled){transform:translateY(-1px)}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .muted{color:var(--muted);font-size:12px}

    .drop{border:2px dashed #3a4254;border-radius:12px;padding:18px;text-align:center;background:#0e1118}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;margin-top:10px;max-height:220px;overflow:auto}
    .thumb{position:relative;border:1px solid #333;border-radius:12px;overflow:hidden;background:#05070c}
    .thumb img{display:block;width:100%;height:90px;object-fit:cover}
    .thumb span{position:absolute;left:6px;bottom:6px;background:rgba(0,0,0,.55);padding:2px 6px;border-radius:6px;font-size:11px}
    .thumb .del{position:absolute;top:6px;right:6px;border:none;border-radius:8px;background:rgba(255,93,93,.9);color:#fff;font-size:12px;padding:2px 6px;cursor:pointer}
    .thumb .del:hover{filter:brightness(0.93)}
    .thumb.selectable{cursor:pointer}

    .preview-box{display:flex;align-items:center;justify-content:center;position:relative;border:1px solid #333;border-radius:12px;overflow:hidden;background:#0c0e13;aspect-ratio:16/9}
    .preview-box img{max-width:100%;max-height:100%;display:none}
    .preview-placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#7f8aa3;font-size:13px;padding:12px;text-align:center}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    code.block{display:block;white-space:pre-wrap;background:#0c0f15;border:1px solid #222;border-radius:10px;padding:10px;color:#bcd;font-size:12px}
    .stat{display:grid;grid-template-columns:1fr auto;gap:6px;font-size:13px}
    progress{width:100%;height:10px;border-radius:5px}
    a.dl{color:#a8ffec;font-size:12px}

    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;max-height:360px;overflow:auto;margin-top:10px}
    .result{border:1px solid #333;border-radius:12px;overflow:hidden;background:#0e1116;display:flex;flex-direction:column}
    .result img{display:block;width:100%;height:120px;object-fit:cover}
    .result .meta{padding:10px;font-size:12px;display:grid;gap:6px}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;font-weight:600;font-size:11px}
    .badge.ok{background:rgba(116,214,128,.15);color:var(--ok);border:1px solid rgba(116,214,128,.3)}
    .badge.bad{background:rgba(255,93,93,.12);color:var(--danger);border:1px solid rgba(255,93,93,.3)}

    details summary{cursor:pointer;list-style:none}

    @media (max-width:1100px){
      .app-header{flex-direction:column;align-items:flex-start;text-align:left}
      .header-actions{align-items:flex-start}
      .wrap{grid-template-columns:1fr;padding:0 16px 24px}
      .info-grid{padding:16px}
    }
    @media (max-width:720px){
      .results{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-main">
      <h1 id="btnBack" class="title-click">üß™ Anomaly Detection</h1>
      <span id="projectLabel" class="muted small-note">Scene mode</span>
    </div>
    <div class="header-actions">
      <div class="nav-links">
        <a class="nav-btn" href="/ui/projects">‚Üê Back to project list</a>
        <a class="nav-btn" href="/ui/models.html">Browse models</a>
      </div>
      <div class="small-note">Upload baseline images ‚Üí train ‚Üí download <code>model.pt</code> ‚Üí test new images</div>
    </div>
  </header>

  <section class="info-grid">
    <div class="info-card">
      <h3>Quick steps</h3>
      <ol class="step-list">
        <li>Pick a scene ID (or open via project) and upload normal-case images.</li>
        <li>Adjust training parameters and start training.</li>
        <li>Watch the job status, download the best model, and test fresh images.</li>
      </ol>
    </div>
    <div class="info-card">
      <h3>Current status</h3>
      <ul class="summary-list">
        <li><span class="summary-label">Dataset</span><span class="summary-value" id="summaryDataset">No images yet</span></li>
        <li><span class="summary-label">Training</span><span class="summary-value" id="summaryTraining">Not started</span></li>
        <li><span class="summary-label">Job state</span><span class="summary-value" id="summaryJob">-</span></li>
        <li><span class="summary-label">Latest model</span><span class="summary-value" id="summaryModel">None</span></li>
        <li><span class="summary-label">Testing</span><span class="summary-value" id="summaryTest">Not tested</span></li>
      </ul>
    </div>
  </section>

  <div class="wrap">
    <section class="card">
      <h3 style="margin-top:0">1) Dataset / Upload</h3>
      <label class="muted">Scene ID / Dataset ID</label>
      <input id="sceneId" type="text" placeholder="e.g. cam_park_01" />

      <div style="height:10px"></div>
      <div id="drop" class="drop" ondragover="event.preventDefault()">
        <div>Drag images here or choose files <input id="fileInput" type="file" accept="image/*" multiple /></div>
        <div class="muted">Supports JPG / PNG and multiple files at once</div>
      </div>
      <div class="toolbar">
        <button id="btnUpload" class="primary">Upload to backend</button>
        <button id="btnClearFiles">Clear list</button>
      </div>
      <div id="fileCount" class="muted">No files selected</div>
      <div id="thumbs" class="thumbs"></div>
      <h3 style="margin:12px 0 6px">Existing images</h3>
      <div class="toolbar" style="justify-content:flex-end;margin-top:0">
        <button id="btnClearGallery" class="warn">Clear list</button>
      </div>
      <div id="gallery" class="thumbs"></div>

      <hr style="border:none;border-top:1px solid #2a2f3a;margin:14px 0" />
      <h3 style="margin:0">2) Train parameters</h3>
      <div id="trainingModeInfo" class="muted" style="margin:6px 0 10px;"></div>
      <div class="row">
        <label class="muted" style="width:120px">img_size</label>
        <input id="imgSize" type="number" value="256" min="64" step="32" />
      </div>
      <div class="row">
        <label class="muted" style="width:120px">epochs</label>
        <input id="epochs" type="number" value="30" min="1" step="1" />
      </div>
      <div class="row">
        <label class="muted" style="width:120px">learning_rate</label>
        <input id="lr" type="number" value="0.0001" step="0.0001" />
      </div>
      <div id="baseModelWrap" style="display:none;">
        <div class="row">
          <label class="muted" style="width:120px">base_model_id</label>
          <input id="baseModelInput" list="baseModelsList" placeholder="Select or type base model id" />
        </div>
        <datalist id="baseModelsList"></datalist>
        <div id="baseModelHelper" class="muted" style="font-size:12px;margin:6px 0 0;">We will load this checkpoint before training.</div>
      </div>
      <div class="toolbar">
        <button id="btnTrain" class="primary">Start training</button>
      </div>
      <div id="trainMsg" class="muted"></div>

      <h3 style="margin:18px 0 6px">3) Job status</h3>
      <div class="stat"><span>Job id</span><code id="jobId">-</code></div>
      <div class="stat"><span>Status</span><code id="jobStatus">-</code></div>
      <div class="stat"><span>Progress</span><span style="min-width:120px"><progress id="jobProg" value="0" max="1"></progress></span></div>
      <div class="stat"><span>Model id</span><code id="modelId">-</code></div>
      <div class="toolbar">
        <button id="btnPoll">Refresh status</button>
        <a id="btnDownload" class="dl" href="#" download style="display:none">Download model.pt</a>
      </div>

      <h3 style="margin:18px 0 6px">4) Test model (Inference)</h3>
      <div class="muted">Pick some images, run inference, and compare the score with the stored threshold from <code>model_id</code>.</div>
      <div class="row">
        <input id="testInput" type="file" accept="image/*" multiple />
        <button id="btnTest" class="primary">Run test</button>
      </div>
      <div id="testMsg" class="muted"></div>
      <div id="testResults" class="results"></div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Image preview</h3>
      <div class="preview-box">
        <img id="previewImage" alt="" />
        <div id="previewPlaceholder" class="preview-placeholder">Select an uploaded or stored image to preview it here.</div>
      </div>
      <div id="previewInfo" class="muted" style="margin-top:8px"></div>
    </section>
  </div>

  <script>
const API_BASE = '';
const params = new URLSearchParams(location.search);
const projectId = params.get('projectId');
const inProject = Boolean(projectId);

const el = (id) => document.getElementById(id);
const sceneId      = el('sceneId');
const fileInput    = el('fileInput');
const drop         = el('drop');
const thumbs       = el('thumbs');
const fileCount    = el('fileCount');
const btnUpload    = el('btnUpload');
const btnClear     = el('btnClearFiles');
const btnClearGallery = el('btnClearGallery');
const imgSize      = el('imgSize');
const epochs       = el('epochs');
const lr           = el('lr');
const trainingModeInfo = el('trainingModeInfo');
const baseModelWrap = el('baseModelWrap');
const baseModelInput = el('baseModelInput');
const baseModelsList = el('baseModelsList');
const baseModelHelper = el('baseModelHelper');
const btnTrain     = el('btnTrain');
const trainMsg     = el('trainMsg');
const jobIdEl      = el('jobId');
const jobStatus    = el('jobStatus');
const jobProg      = el('jobProg');
const modelIdEl    = el('modelId');
const btnPoll      = el('btnPoll');
const btnDownload  = el('btnDownload');
const previewImage = el('previewImage');
const previewInfo  = el('previewInfo');
const previewPlaceholder = el('previewPlaceholder');
const testInput    = el('testInput');
const btnTest      = el('btnTest');
const testMsg      = el('testMsg');
const testResults  = el('testResults');
const projectLabel = el('projectLabel');
const summaryDataset  = el('summaryDataset');
const summaryTraining = el('summaryTraining');
const summaryJob      = el('summaryJob');
const summaryModel    = el('summaryModel');
const summaryTest     = el('summaryTest');

(function ensureGallery(){
  if (!el('gallery')) {
    const g = document.createElement('div');
    g.id = 'gallery';
    g.className = 'thumbs';
    drop.insertAdjacentElement('afterend', g);
  }
})();

let projectMeta = null;
let baseModelOptions = [];
let baseModelsLoading = false;
let files = [];
let previewSource = null;
let jobTimer = null;
let serverImageCount = 0;
let lastTestCount = 0;
let currentGalleryItems = [];
let currentGalleryContext = { type: null, id: null };

function refreshSummary(){
  if (summaryDataset) {
    const info = [];
    if (serverImageCount > 0) info.push(`${serverImageCount} stored`);
    if (files.length > 0) info.push(`${files.length} ready to upload`);
    summaryDataset.textContent = info.join(' ‚Ä¢ ') || 'No images yet';
  }
  if (summaryTraining) {
    const text = (trainMsg.textContent || '').trim();
    summaryTraining.textContent = text || 'Not started';
  }
  if (summaryJob) {
    const status = (jobStatus.textContent || '').trim();
    const prog = Number(jobProg.value || 0);
    const pct = Math.round(prog * 100);
    summaryJob.textContent = status && status !== '-' ? (prog > 0 ? `${status} ‚Ä¢ ${pct}%` : status) : 'No job';
  }
  if (summaryModel) {
    const value = (modelIdEl.textContent || '').trim();
    summaryModel.textContent = value && value !== '-' ? value : 'None';
  }
  if (summaryTest) {
    const base = (testMsg.textContent || '').trim();
    summaryTest.textContent = lastTestCount > 0 ? `${base ? base + ' ‚Ä¢ ' : ''}${lastTestCount} images` : (base || 'Not tested');
  }
  if (projectLabel) {
    const override = projectLabel.dataset ? projectLabel.dataset.labelOverride : undefined;
    projectLabel.textContent = override || (inProject ? `Project mode: ${projectId}` : 'Scene mode');
  }
}

if (typeof MutationObserver !== 'undefined') {
  const observer = new MutationObserver(refreshSummary);
  [trainMsg, testMsg, jobStatus, modelIdEl].forEach(node => {
    if (node) observer.observe(node, {characterData:true, childList:true, subtree:true});
  });
}

async function populateBaseModelOptions(){
  if (!baseModelsList || !baseModelHelper) return;
  if (baseModelsLoading) return;
  baseModelsLoading = true;
  baseModelHelper.textContent = 'Loading available models‚Ä¶';
  try {
    const res = await fetch(`${API_BASE}/models`);
    if (!res.ok) throw new Error(await res.text());
    const items = await res.json();
    const map = new Map();
    if (Array.isArray(items)) {
      for (const item of items) {
        if (item && item.model_id && !map.has(item.model_id)) {
          map.set(item.model_id, item);
        }
      }
    }
    baseModelOptions = Array.from(map.values());
    if (baseModelsList) {
      const escapeAttr = (str) => String(str ?? '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;');
      const optionsHtml = baseModelOptions.map((m) => {
        const id = escapeAttr(m.model_id);
        const parts = [];
        if (m.project_id) parts.push(`project:${m.project_id}`);
        if (m.mode) parts.push(m.mode);
        const suffix = parts.length ? ` (${parts.join(' ¬∑ ')})` : '';
        return `<option value="${id}">${id}${suffix}</option>`;
      }).join(' ');
      baseModelsList.innerHTML = optionsHtml;
    }
    baseModelHelper.textContent = 'Select the checkpoint to continue from or type a model id.';
  } catch (err) {
    console.error(err);
    baseModelHelper.textContent = 'Failed to load model list, type the model id manually.';
  } finally {
    baseModelsLoading = false;
  }
}

async function applyTrainingModeUI(mode){
  if (!trainingModeInfo) return;
  const normalized = (mode || 'anomaly').toLowerCase();
  if (normalized === 'finetune') {
    trainingModeInfo.textContent = 'Mode: Fine-tune existing model';
    if (baseModelWrap) baseModelWrap.style.display = '';
    if (baseModelHelper) {
      baseModelHelper.style.display = 'block';
      baseModelHelper.textContent = 'Loading available models‚Ä¶';
    }
    await populateBaseModelOptions();
    if (baseModelInput) {
      if (projectMeta && projectMeta.last_model_id) {
        baseModelInput.value = projectMeta.last_model_id;
      }
    }
    return;
  }
  if (normalized === 'yolo') {
    trainingModeInfo.textContent = 'Mode: YOLO object detection';
    if (baseModelWrap) baseModelWrap.style.display = 'none';
    if (baseModelHelper) baseModelHelper.style.display = 'none';
    if (baseModelInput) baseModelInput.value = '';
    return;
  }
  trainingModeInfo.textContent = 'Mode: Anomaly detection';
  if (baseModelWrap) baseModelWrap.style.display = 'none';
  if (baseModelHelper) baseModelHelper.style.display = 'none';
  if (baseModelInput) baseModelInput.value = '';
}

async function loadProjectMeta(){
  if (!inProject || !projectLabel) {
    await applyTrainingModeUI('anomaly');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/projects/${encodeURIComponent(projectId)}`);
    if (!res.ok) throw new Error(await res.text());
    const meta = await res.json();
    const mode = (meta.training_mode || 'anomaly').toLowerCase();
    if (mode === 'finetune') {
      const target = `/ui/fine_tune.html?projectId=${encodeURIComponent(projectId)}`;
      window.location.replace(target);
      return;
    }
    if (mode === 'yolo') {
      const target = `/ui/yolo.html?projectId=${encodeURIComponent(projectId)}`;
      window.location.replace(target);
      return;
    }
    projectMeta = meta;
    if (projectLabel.dataset) {
      projectLabel.dataset.labelOverride = meta.name ? `Project: ${meta.name}` : `Project: ${projectId}`;
    }
    await applyTrainingModeUI('anomaly');
  } catch (err) {
    console.error(err);
    projectMeta = null;
    if (projectLabel.dataset) {
      projectLabel.dataset.labelOverride = `Project: ${projectId}`;
    }
    await applyTrainingModeUI('anomaly');
  }
  refreshSummary();
}

function setDownload(modelId){
  if(!modelId){ btnDownload.style.display='none'; return; }
  btnDownload.href = `${API_BASE}/models/${encodeURIComponent(modelId)}/download`;
  btnDownload.style.display='inline-block';
}

function toStaticUrl(p){
  if (!p) return null;
  if (p.startsWith('/') || /^https?:\/\//i.test(p)) {
    return `${API_BASE}${p}`;
  }
  const rel = p.replace(/^data[\\/]/, '').replace(/\\/g, '/');
  return `${API_BASE}/static/${rel}`;
}

async function loadInitialImages(){
  try{
    let res;
    let context = { type: null, id: null };
    if (inProject) {
      context = { type: 'project', id: projectId };
      res = await fetch(`${API_BASE}/projects/${encodeURIComponent(projectId)}/images`);
    } else {
      const s = sceneId.value.trim();
      if (!s) {
        currentGalleryContext = { type: null, id: null };
        renderGallery([]);
        return;
      }
      context = { type: 'scene', id: s };
      res = await fetch(`${API_BASE}/datasets/${encodeURIComponent(s)}/images`);
    }
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    currentGalleryContext = context;
    renderGallery(data.items || []);
  }catch(err){
    console.error('loadInitialImages error:', err);
    currentGalleryContext = { type: null, id: null };
    renderGallery([]);
  }
}

function renderGallery(items){
  const grid = document.getElementById('gallery');
  if (!grid) return;
  grid.innerHTML = '';
  const list = Array.isArray(items) ? items : [];
  currentGalleryItems = list.slice();
  serverImageCount = list.length;
  const ctx = currentGalleryContext;
  if (btnClearGallery) {
    btnClearGallery.disabled = !serverImageCount || !ctx.type;
  }
  refreshSummary();
  if (!list.length) {
    const p = document.createElement('div');
    p.className = 'muted';
    p.style.marginTop = '6px';
    p.textContent = 'No stored images yet';
    grid.appendChild(p);
    if (previewSource && previewSource.origin && previewSource.origin.startsWith('Stored')) {
      showPreview(null);
    }
    return;
  }
  list.forEach((it, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'thumb selectable';
    wrap.innerHTML = `
      <img src="${toStaticUrl(it.url) || it.url}" alt="${it.filename}">
      <span>${i+1}</span>
      <button class="del" title="Remove this image">Delete</button>
    `;
    const resolvedUrl = toStaticUrl(it.url) || it.url;
    wrap.addEventListener('click', () => {
      if (resolvedUrl) {
        const origin = ctx.type === 'project' ? 'Stored in project' : 'Stored in dataset';
        showPreview(resolvedUrl, it.filename || '', origin);
      }
    });

    wrap.querySelector('.del').addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!ctx.type || !ctx.id) {
        alert('Dataset/project context missing.');
        return;
      }
      if (!confirm(`Delete "${it.filename}" permanently?`)) return;
      try {
        const base = ctx.type === 'project'
          ? `${API_BASE}/projects/${encodeURIComponent(ctx.id)}/images/${encodeURIComponent(it.filename)}`
          : `${API_BASE}/datasets/${encodeURIComponent(ctx.id)}/images/${encodeURIComponent(it.filename)}`;
        const res = await fetch(base, { method:'DELETE' });
        if (!res.ok) throw new Error(await res.text());
        await loadInitialImages();
      } catch (err) {
        alert('Failed to delete image: ' + err.message);
      }
    });

    grid.appendChild(wrap);
  });
  if (!previewSource && list.length) {
    const first = list[0];
    const resolved = toStaticUrl(first.url) || first.url;
    if (resolved) {
      const origin = ctx.type === 'project' ? 'Stored in project' : 'Stored in dataset';
      showPreview(resolved, first.filename || '', origin);
    }
  }
}

async function clearStoredImages(){
  if (!btnClearGallery) return;
  if (!currentGalleryItems.length) {
    alert('No stored images to clear.');
    return;
  }
  const ctx = currentGalleryContext;
  if (!ctx.type || !ctx.id) {
    alert('No dataset/project context available.');
    return;
  }
  const targetLabel = ctx.type === 'project'
    ? `project "${ctx.id}"`
    : `dataset "${ctx.id}"`;
  if (!confirm(`Delete all images from ${targetLabel}?`)) return;
  const originalText = btnClearGallery.textContent;
  btnClearGallery.disabled = true;
  btnClearGallery.textContent = 'Clearing...';
  try {
    for (const item of currentGalleryItems) {
      const endpoint = ctx.type === 'project'
        ? `${API_BASE}/projects/${encodeURIComponent(ctx.id)}/images/${encodeURIComponent(item.filename)}`
        : `${API_BASE}/datasets/${encodeURIComponent(ctx.id)}/images/${encodeURIComponent(item.filename)}`;
      const res = await fetch(endpoint, { method:'DELETE' });
      if (!res.ok) throw new Error(await res.text());
    }
    await loadInitialImages();
  } catch (err) {
    console.error('clearStoredImages error:', err);
    alert('Failed to clear stored images: ' + err.message);
  } finally {
    btnClearGallery.textContent = originalText;
    btnClearGallery.disabled = false;
  }
}



function updateThumbs(){
  thumbs.innerHTML = '';
  files.forEach((f,i)=>{
    const url = URL.createObjectURL(f);
    const div = document.createElement('div');
    div.className='thumb';
    div.innerHTML = `<img src="${url}"><span>${i+1}</span>`;
    div.onclick = ()=> showPreview(url, f.name || `upload_${i}`, 'Upload queue');
    thumbs.appendChild(div);
  });
  fileCount.textContent = files.length ? `Selected ${files.length} file(s)` : 'No files selected';
  if (!files.length && previewSource && previewSource.origin === 'Upload queue') {
    showPreview(null);
  }
  if(files[0] && !previewSource){
    const firstThumb = thumbs.querySelector('.thumb img');
    if (firstThumb) {
      showPreview(firstThumb.src, files[0].name || 'first upload', 'Upload queue');
    }
  }
  refreshSummary();
}

function showPreview(url, label = '', origin){
  if (!previewImage || !previewPlaceholder) return;
  previewSource = url ? { url, label, origin } : null;
  if (url) {
    previewImage.src = url;
    previewImage.style.display = 'block';
    previewPlaceholder.style.display = 'none';
  } else {
    previewImage.src = '';
    previewImage.style.display = 'none';
    previewPlaceholder.style.display = 'flex';
  }
  if (previewInfo) {
    const parts = [];
    if (label) parts.push(label);
    if (origin) parts.push(origin);
    previewInfo.textContent = parts.join(' ‚Ä¢ ');
  }
}

async function uploadFiles(){
  if (!files.length) return alert('No files to upload');
  const fd = new FormData();
  files.forEach(f => fd.append('files', f, f.name));

  let url;
  if (inProject) {
    url = `${API_BASE}/projects/${encodeURIComponent(projectId)}/upload`;
  } else {
    const scene = sceneId.value.trim();
    if (!scene) return alert('Please fill the scene ID first');
    url = `${API_BASE}/datasets/${encodeURIComponent(scene)}/upload`;
  }

  btnUpload.disabled = true; btnUpload.textContent='Uploading‚Ä¶';
  try{
    const res = await fetch(url, { method:'POST', body: fd });
    const js  = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(js.detail || res.statusText);
    await loadInitialImages();
    alert('Upload completed');
  }catch(err){
    console.error(err);
    alert('Upload failed: ' + err.message);
  }finally{
    btnUpload.disabled = false; btnUpload.textContent='Upload to backend';
    refreshSummary();
  }
}

async function startTrain(){
  setDownload(null);
  let res;
  if (inProject) {
    const payload = {
      img_size: parseInt(imgSize.value||256),
      epochs:   parseInt(epochs.value||30),
      lr:       parseFloat(lr.value||0.0001)
    };
    const mode = (projectMeta?.training_mode || 'anomaly').toLowerCase();
    if (mode === 'finetune') {
      const baseId = (baseModelInput?.value || '').trim();
      if (!baseId) {
        trainMsg.textContent = 'Please select a base model before starting fine-tune.';
        if (baseModelInput) baseModelInput.focus();
        return;
      }
      payload.base_model_id = baseId;
    } else if (mode === 'yolo') {
      alert('Use the YOLO training page for this project.');
      window.location.href = `/ui/yolo.html?projectId=${encodeURIComponent(projectId)}`;
      return;
    }
    trainMsg.textContent = 'Submitting training job‚Ä¶';
    res = await fetch(`${API_BASE}/projects/${encodeURIComponent(projectId)}/train`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
  } else {
    const scene = sceneId.value.trim();
    if (!scene) {
      trainMsg.textContent = 'Please fill the scene ID first';
      sceneId.focus();
      return;
    }
    trainMsg.textContent = 'Submitting training job‚Ä¶';
    res = await fetch(`${API_BASE}/train`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        scene_id: scene,
        img_size: parseInt(imgSize.value||256),
        epochs:   parseInt(epochs.value||30),
        lr:       parseFloat(lr.value||0.0001)
      })
    });
  }
  const js = await res.json().catch(()=>({}));
  if(!res.ok){
    trainMsg.textContent = 'Failed to submit job';
    alert(js.detail || res.statusText);
    refreshSummary();
    return;
  }
  jobIdEl.textContent = js.job_id || '-';
  jobStatus.textContent = 'queued';
  jobProg.value = 0; modelIdEl.textContent='-';
  trainMsg.textContent = 'Job accepted';
  if(jobTimer) clearInterval(jobTimer);
  jobTimer = setInterval(pollStatus, 2000);
  refreshSummary();
}

async function pollStatus(){
  const id = jobIdEl.textContent.trim(); if(!id || id==='-') return;
  try{
    const res = await fetch(`${API_BASE}/jobs/${encodeURIComponent(id)}`);
    const js  = await res.json();
    if(!res.ok) throw new Error(js.detail||res.statusText);
    jobStatus.textContent = js.status || '-';
    jobProg.value = js.progress ?? 0;
    if(js.model_id){ modelIdEl.textContent = js.model_id; setDownload(js.model_id); }
    const statusLower = (js.status||'').toLowerCase();
    if(['finished','failed','canceled','error'].includes(statusLower)){
      if(jobTimer) clearInterval(jobTimer);
      if (statusLower === 'finished' && inProject) {
        await loadProjectMeta();
      }
    }
  }catch(err){ console.error(err); }
  refreshSummary();
}

async function testModel(){
  const mid = (modelIdEl.textContent||'').trim();
  if(!mid || mid==='-') return alert('Train a model first or wait for the job to finish');
  const up = testInput.files ? Array.from(testInput.files) : [];
  if(!up.length) return alert('Select images to test');
  const fd = new FormData(); up.forEach(f=> fd.append('files', f, f.name));
  btnTest.disabled = true; testMsg.textContent = 'Running inference‚Ä¶';
  try{
    const res = await fetch(`${API_BASE}/models/${encodeURIComponent(mid)}/test`, { method:'POST', body: fd });
    const js  = await res.json();
    if(!res.ok) throw new Error(js.detail||res.statusText);
    renderTestResults(js.items);
    testMsg.textContent = `Success: ${js.items.length} image(s)`;
  }catch(err){
    console.error(err);
    testMsg.textContent = '‚ùå Test failed: '+err.message;
    alert('Test failed: '+err.message);
    lastTestCount = 0;
  }finally{
    btnTest.disabled = false;
    refreshSummary();
  }
}

function renderTestResults(items){
  lastTestCount = Array.isArray(items) ? items.length : 0;
  testResults.innerHTML = '';
  if(!items || !items.length){
    testResults.innerHTML = '<div class="muted">No results</div>';
    refreshSummary();
    return;
  }
  items.forEach(it=>{
    const div = document.createElement('div');
    div.className = 'result';
    const rawUrl = it.overlay_url || it.heatmap_url || it.image_url || it.result_image || it.heatmap_image;
    const imgUrl = toStaticUrl(rawUrl);
    const thr    = (it.thr ?? it.threshold ?? 0);
    const badge = it.is_anomaly ? '<span class="badge bad">ANOMALY</span>' : '<span class="badge ok">NORMAL</span>';
    div.innerHTML = `
      <img src="${imgUrl || ''}" alt="">
      <div class="meta">
        <div>${badge} <strong>${it.filename || ''}</strong></div>
        <div>score: ${Number(it.score||0).toFixed(4)} ‚Ä¢ thr: ${Number(thr).toFixed(4)}</div>
        ${imgUrl ? `<a class="dl" href="${imgUrl}" target="_blank">Open result</a>` : ''}
      </div>`;
    testResults.appendChild(div);
  });
  refreshSummary();
}

btnUpload.onclick = uploadFiles;
btnTrain.onclick  = startTrain;
btnPoll.onclick   = pollStatus;
btnTest.onclick   = testModel;

fileInput.addEventListener('change', (e)=>{
  files = Array.from(e.target.files||[]);
  updateThumbs();
});

drop.addEventListener('drop', (e)=>{
  e.preventDefault();
  files = files.concat(Array.from(e.dataTransfer.files||[]));
  updateThumbs();
});

drop.addEventListener('dragover', (e)=>{ e.preventDefault(); });

btnClear.onclick = ()=>{
  files = [];
  updateThumbs();
};

if (btnClearGallery) {
  btnClearGallery.onclick = clearStoredImages;
}

window.addEventListener('load', async ()=>{
  await applyTrainingModeUI('anomaly');
  if (inProject) {
    sceneId.value = `(project) ${projectId}`;
    sceneId.disabled = true;
    await loadProjectMeta();
  } else {
    sceneId.value = 'cam_park_01';
  }
  await loadInitialImages();
  refreshSummary();
});

const back = document.getElementById('btnBack');
if (back) back.onclick = () => { window.location.href = '/ui/projects'; };
  </script>
</body>
</html>
