<!DOCTYPE html>
<html lang="th">
<head>
  <link rel="icon" href="/ui/favicon.ico?v=1">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anomaly Detection ‚Äì Frontend MVP</title>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --muted:#7f8aa3; --accent:#4ad6b8; --danger:#ff5d5d; --ok:#74d680; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e9eef7;font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif}
    header{padding:16px 20px;border-bottom:1px solid #222}
    h1{font-size:20px;margin:0}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px}
    .card{background:var(--panel);border:1px solid #222;border-radius:12px;padding:14px}
    .row{display:flex;gap:8px;align-items:center}
    input[type=text], input[type=number]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #333;background:#0e1016;color:#e9eef7}
    button{padding:8px 12px;border-radius:8px;border:1px solid #2a2f3a;background:#111520;color:#e9eef7;cursor:pointer}
    button.primary{background:var(--accent);color:#0b1115;border-color:#2b8f80;font-weight:600}
    button.warn{background:#2b1113;border-color:#61272c;color:#ffc9c9}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .drop{border:2px dashed #3a4254;border-radius:12px;padding:16px;text-align:center;background:#0e1118}
    .thumbs{display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;margin-top:10px;max-height:220px;overflow:auto}
    .thumb{position:relative;border:1px solid #333;border-radius:10px;overflow:hidden}
    .thumb img{display:block;width:100%;height:90px;object-fit:cover}
    .thumb span{position:absolute;left:6px;bottom:6px;background:rgba(0,0,0,.55);padding:2px 6px;border-radius:6px;font-size:11px}
    .canvas-wrap{position:relative;border:1px solid #333;border-radius:12px;overflow:hidden;background:#0c0e13}
    canvas{display:block;width:100%;height:auto}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    code.block{display:block;white-space:pre-wrap;background:#0c0f15;border:1px solid #222;border-radius:10px;padding:8px;color:#bcd}
    .stat{display:grid;grid-template-columns:1fr auto;gap:6px;font-size:13px}
    progress{width:100%}
    a.dl{color:#a8ffec}

    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö */
    .results{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-height:360px;overflow:auto;margin-top:10px}
    .result{border:1px solid #333;border-radius:10px;overflow:hidden;background:#0e1116}
    .result img{display:block;width:100%;height:120px;object-fit:cover}
    .result .meta{padding:8px;font-size:12px;display:grid;gap:4px}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;font-weight:600}
    .badge.ok{background:rgba(116,214,128,.15);color:var(--ok);border:1px solid rgba(116,214,128,.3)}
    .badge.bad{background:rgba(255,93,93,.12);color:var(--danger);border:1px solid rgba(255,93,93,.3)}
    .title-click { cursor: pointer; }
.title-click:hover { color: var(--accent); }
.title-click:active { opacity: .85; }
.thumb .del {
  position:absolute; top:6px; right:6px; border:none; border-radius:8px;
  background:rgba(255,93,93,.9); color:#fff; font-size:12px; padding:2px 6px;
  cursor:pointer;
}
.thumb .del:hover { filter: brightness(0.95); }
.thumb.selectable { cursor: pointer; }

.thumb.selectable { cursor: pointer; }
.thumb .del {
  position:absolute; top:6px; right:6px; border:none; border-radius:8px;
  background:rgba(255,93,93,.9); color:#fff; font-size:12px; padding:2px 6px;
  cursor:pointer;
}
.thumb .del:hover { filter: brightness(0.95); }

  </style>
</head>
<body>
  
   
 <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;border-bottom:1px solid #222">
  <h1 id="btnBack" class="title-click" style="margin:0">üß™ Anomaly Detection</h1>
  <div class="muted">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡∏ï‡∏¥ ‚Üí (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ROI ‚Üí ‡∏Å‡∏î Train ‚Üí ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î <code>model.pt</code> ‚Üí <strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•</strong></div>
</header>


  <div class="wrap">
    <!-- LEFT COLUMN -->
    <section class="card">
      <h3 style="margin-top:0">1) Dataset / Upload</h3>
      <label class="muted">Scene ID / Dataset ID</label>
      <input id="sceneId" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô cam_park_01" />

      <div style="height:10px"></div>
      <div id="drop" class="drop" ondragover="event.preventDefault()">
        <div>‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠ <input id="fileInput" type="file" accept="image/*" multiple /></div>
        <div class="muted">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .jpg/.png ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå</div>
      </div>
      <div class="toolbar">
        <button id="btnUpload" class="primary">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡πÅ‡∏ö‡πá‡∏Å‡πÄ‡∏≠‡∏ô‡∏î‡πå</button>
        <button id="btnClearFiles">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>
      <div id="fileCount" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå</div>
      <div id="thumbs" class="thumbs"></div>
      <h3 style="margin:12px 0 6px">Existing images</h3>
      <div id="gallery" class="thumbs"></div>

      <hr style="border:none;border-top:1px solid #2a2f3a;margin:14px 0" />
      <h3 style="margin:0">2) Train parameters</h3>
      <div class="row">
        <label class="muted" style="width:120px">img_size</label>
        <input id="imgSize" type="number" value="256" min="64" step="32" />
      </div>
      <div class="row">
        <label class="muted" style="width:120px">epochs</label>
        <input id="epochs" type="number" value="30" min="1" step="1" />
      </div>
      <div class="row">
        <label class="muted" style="width:120px">learning_rate</label>
        <input id="lr" type="number" value="0.0001" step="0.0001" />
      </div>
      <div class="toolbar">
        <button id="btnTrain" class="primary">‡πÄ‡∏£‡∏¥‡πà‡∏° Train</button>
      </div>
      <div id="trainMsg" class="muted"></div>

      <hr style="border:none;border-top:1px solid #2a2f3a;margin:14px 0" />
      <h3 style="margin:0">3) Job status</h3>
      <div class="stat"><span>job_id</span><code id="jobId">-</code></div>
      <div class="stat"><span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><code id="jobStatus">-</code></div>
      <div class="stat"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span><span style="min-width:120px"><progress id="jobProg" value="0" max="1"></progress></span></div>
      <div class="stat"><span>model_id</span><code id="modelId">-</code></div>
      <div class="toolbar">
        <button id="btnPoll">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
        <a id="btnDownload" class="dl" href="#" download style="display:none">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î model.pt</a>
      </div>

      <hr style="border:none;border-top:1px solid #2a2f3a;margin:14px 0" />
      <h3 style="margin:0">4) Test model (Inference)</h3>
      <div class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ <code>model_id</code> ‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>
      <div class="row">
        <input id="testInput" type="file" accept="image/*" multiple />
        <button id="btnTest" class="primary">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏•</button>
      </div>
      <div id="testMsg" class="muted"></div>
      <div id="testResults" class="results"></div>
    </section>

    <!-- RIGHT COLUMN -->
    <section class="card">
      <h3 style="margin-top:0">ROI (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‚Äì ‡∏ß‡∏≤‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</h3>
      <div class="muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î ‚Ä¢ ‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ ‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° Clear ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á</div>
   <div class="canvas-wrap" style="position:relative;border:1px solid #333;border-radius:12px;overflow:hidden;background:#0c0e13;aspect-ratio:16/9">
  <canvas id="canvas" style="display:block;width:100%;height:100%"></canvas>
</div>
      <div class="toolbar">
        <button id="btnClearRoi" class="warn">Clear ROI</button>
        <button id="btnSaveRoi" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ROI</button>
        <span id="roiMsg" class="muted"></span>
      </div>
      <details style="margin-top:8px">
        <summary class="muted">‡∏î‡∏µ‡∏ö‡∏±‡∏Å</summary>
        <code id="dbg" class="block"></code>
      </details>
    </section>
  </div>

  <script>
/* ===================== CONFIG / STATE ===================== */
const API_BASE = ''; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å relative origin, ‡∏ï‡∏±‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS/host mismatch

// ‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
const params      = new URLSearchParams(location.search);
const projectId   = params.get('projectId');
const inProject   = !!projectId;

// DOM helpers
const el = (id)=>document.getElementById(id);

// DOM refs
const sceneId      = el('sceneId');
const fileInput    = el('fileInput');
const drop         = el('drop');
const thumbs       = el('thumbs');
const fileCount    = el('fileCount');
const btnUpload    = el('btnUpload');
const btnClear     = el('btnClearFiles');

const imgSize      = el('imgSize');
const epochs       = el('epochs');
const lr           = el('lr');
const btnTrain     = el('btnTrain');
const trainMsg     = el('trainMsg');

const jobIdEl      = el('jobId');
const jobStatus    = el('jobStatus');
const jobProg      = el('jobProg');
const modelIdEl    = el('modelId');
const btnPoll      = el('btnPoll');
const btnDownload  = el('btnDownload');

const canvas       = el('canvas');
const ctx          = canvas.getContext('2d');
const btnClearRoi  = el('btnClearRoi');
const btnSaveRoi   = el('btnSaveRoi');
const roiMsg       = el('roiMsg');
const dbg          = el('dbg');

const testInput    = el('testInput');
const btnTest      = el('btnTest');
const testMsg      = el('testMsg');
const testResults  = el('testResults');

// ‡∏™‡∏£‡πâ‡∏≤‡∏á #gallery ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
(function ensureGallery(){
  if (!el('gallery')) {
    const g = document.createElement('div');
    g.id = 'gallery';
    g.className = 'thumbs';
    drop.insertAdjacentElement('afterend', g);
  }
})();

// state
let files = [];
let activeImgUrl = null;
const points = [];
let closed = false;
let jobTimer = null;

/* ===================== UTILS ===================== */
function setDownload(modelId){
  if(!modelId){ btnDownload.style.display='none'; return; }
  btnDownload.href = `${API_BASE}/models/${encodeURIComponent(modelId)}/download`;
  btnDownload.style.display='inline-block';
}

function toStaticUrl(p){
  if(!p) return null;
  const rel = p.replace(/^data[\\/]/,'').replace(/\\/g,'/');
  return `${API_BASE}/static/${rel}`;
}
function syncCanvas() {
  const r = canvas.getBoundingClientRect();   // ‡∏Ç‡∏ô‡∏≤‡∏î "‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡πÄ‡∏´‡πá‡∏ô" (CSS px)
  canvas.width  = Math.round(r.width);        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ backing-store ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πä‡∏∞
  canvas.height = Math.round(r.height);
}
window.addEventListener('resize', syncCanvas);
window.addEventListener('load',   syncCanvas);

/* ===================== GALLERY (existing images) ===================== */
async function loadInitialImages() {
  try{
    let res;
    if (inProject) {
      res = await fetch(`${API_BASE}/projects/${encodeURIComponent(projectId)}/images`);
    } else {
      const s = sceneId.value.trim();
      if (!s) { renderGallery([]); return; }
      res = await fetch(`${API_BASE}/datasets/${encodeURIComponent(s)}/images`);
    }
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    renderGallery(data.items || []);
  }catch(e){
    console.error('loadInitialImages error:', e);
    renderGallery([]);
  }
}

function scrollToROI() {
  const c = document.getElementById('canvas');
  if (c) c.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function renderGallery(items) {
  const grid = document.getElementById('gallery');
  grid.innerHTML = '';
  if (!items.length) {
    const p = document.createElement('div');
    p.className = 'muted'; p.style.marginTop = '6px';
    p.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ';
    grid.appendChild(p);
    return;
  }
  items.forEach((it, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'thumb selectable';
    wrap.innerHTML = `
      <img src="${it.url}" alt="${it.filename}">
      <span>${i+1}</span>
      <button class="del" title="‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ">‡∏•‡∏ö</button>
    `;

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏π‡∏õ ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤ ROI + ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™
    wrap.addEventListener('click', () => {
      loadToCanvas(it.url);
      scrollToROI();
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö ‚Üí ‡∏Å‡∏±‡∏ô propagation ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏π‡∏õ
    const delBtn = wrap.querySelector('.del');
    delBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!confirm(`‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå "${it.filename}" ‡∏ñ‡∏≤‡∏ß‡∏£?`)) return;
      try {
        const base = inProject
          ? `${API_BASE}/projects/${encodeURIComponent(projectId)}/images/${encodeURIComponent(it.filename)}`
          : `${API_BASE}/datasets/${encodeURIComponent(sceneId.value.trim())}/images/${encodeURIComponent(it.filename)}`;
        const res = await fetch(base, { method:'DELETE' });
        if (!res.ok) throw new Error(await res.text());
        await loadInitialImages();
      } catch (err) {
        alert('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });

    grid.appendChild(wrap);
    
  });
}

/* ===================== LOCAL FILE THUMBS (upload buffer) ===================== */
function updateThumbs(){
  thumbs.innerHTML = '';
  files.forEach((f,i)=>{
    const url = URL.createObjectURL(f);
    const div = document.createElement('div');
    div.className='thumb';
    div.innerHTML = `<img src="${url}"><span>${i+1}</span>`;
    div.onclick = ()=> loadToCanvas(url);
    thumbs.appendChild(div);
  });
  fileCount.textContent = files.length ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ ${files.length} ‡πÑ‡∏ü‡∏•‡πå` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå';
  if(files[0] && !activeImgUrl){ loadToCanvas(URL.createObjectURL(files[0])); }
}

/* ===================== CANVAS / ROI ===================== */
function loadToCanvas(url){
  activeImgUrl = url; points.length=0; closed=false; draw();
  const img = new Image(); img.onload=()=>{
    const scale = Math.min(canvas.width/img.width, canvas.height/img.height);
    const w = img.width*scale, h = img.height*scale;
    const x = (canvas.width - w)/2, y = (canvas.height - h)/2;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#0b0e13'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, x,y,w,h);
    canvas.__imgMeta = {x,y,w,h,scale,origW:img.width,origH:img.height};
    draw();
  }; img.src=url;
}

function canvasToImageXY(cx, cy){
  const m = canvas.__imgMeta; if(!m) return null;
  if(cx<m.x||cy<m.y||cx>m.x+m.w||cy>m.y+m.h) return null;
  const ix = (cx - m.x)/m.w * m.origW;
  const iy = (cy - m.y)/m.h * m.origH;
  return {x: Math.round(ix), y: Math.round(iy)};
}

function imageToCanvasXY(ix, iy){
  const m = canvas.__imgMeta; if(!m) return null;
  return { x: m.x + (ix/m.origW)*m.w, y: m.y + (iy/m.origH)*m.h };
}

function draw(){
  const m = canvas.__imgMeta; if(m && activeImgUrl){
    const img = new Image(); img.onload=()=>{
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle='#0b0e13'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, m.x,m.y,m.w,m.h);
      if(points.length){
        ctx.lineWidth=2; ctx.strokeStyle= closed?'#4ad6b8':'#ffd166';
        ctx.fillStyle = 'rgba(74,214,184,0.15)';
        ctx.beginPath();
        const p0 = imageToCanvasXY(points[0].x, points[0].y);
        ctx.moveTo(p0.x, p0.y);
        for(let i=1;i<points.length;i++){
          const p = imageToCanvasXY(points[i].x, points[i].y);
          ctx.lineTo(p.x, p.y);
        }
        if(closed){ ctx.closePath(); ctx.fill(); }
        ctx.stroke();
        points.forEach(pt=>{
          const p = imageToCanvasXY(pt.x, pt.y);
          ctx.fillStyle='#e9eef7'; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
        });
      }
    }; img.src = activeImgUrl;
  }
}

/* ===================== ACTIONS ===================== */
async function uploadFiles() {
  if (!files.length) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå');
  const fd = new FormData();
  files.forEach(f => fd.append('files', f, f.name));

  let url;
  if (inProject) {
    url = `${API_BASE}/projects/${encodeURIComponent(projectId)}/upload`;
  } else {
    const scene = sceneId.value.trim();
    if (!scene) return alert('‡∏Å‡∏£‡∏≠‡∏Å Scene ID ‡∏Å‡πà‡∏≠‡∏ô');
    url = `${API_BASE}/datasets/${encodeURIComponent(scene)}/upload`;
  }

  btnUpload.disabled = true; btnUpload.textContent='‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‚Ä¶';
  try{
    const res = await fetch(url, { method:'POST', body: fd });
    const js  = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(js.detail || res.statusText);
    await loadInitialImages(); // reload gallery
    alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }catch(err){
    console.error(err);
    alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message);
  }finally{
    btnUpload.disabled = false; btnUpload.textContent='‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡πÅ‡∏ö‡πá‡∏Å‡πÄ‡∏≠‡∏ô‡∏î‡πå';
  }
}

async function startTrain() {
  trainMsg.textContent = '‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏£‡∏ô...'; setDownload(null);
  let res;
  if (inProject) {
    res = await fetch(`${API_BASE}/projects/${encodeURIComponent(projectId)}/train`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        img_size: parseInt(imgSize.value||256),
        epochs:   parseInt(epochs.value||30),
        lr:       parseFloat(lr.value||0.0001)
      })
    });
  } else {
    const scene = sceneId.value.trim();
    if (!scene) { trainMsg.textContent='‡∏Å‡∏£‡∏≠‡∏Å Scene ID ‡∏Å‡πà‡∏≠‡∏ô'; return; }
    res = await fetch(`${API_BASE}/train`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        scene_id: scene,
        img_size: parseInt(imgSize.value||256),
        epochs:   parseInt(epochs.value||30),
        lr:       parseFloat(lr.value||0.0001)
      })
    });
  }
  const js = await res.json().catch(()=>({}));
  if(!res.ok){ trainMsg.textContent = '‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; alert(js.detail || res.statusText); return; }
  jobIdEl.textContent = js.job_id || '-';
  jobStatus.textContent = 'queued';
  jobProg.value = 0; modelIdEl.textContent='-';
  trainMsg.textContent = '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
  if(jobTimer) clearInterval(jobTimer);
  jobTimer = setInterval(pollStatus, 2000);
}

async function pollStatus(){
  const id = jobIdEl.textContent.trim(); if(!id || id==='-') return;
  try{
    const res = await fetch(`${API_BASE}/jobs/${encodeURIComponent(id)}`);
    const js  = await res.json();
    if(!res.ok) throw new Error(js.detail||res.statusText);
    jobStatus.textContent = js.status || '-';
    jobProg.value = js.progress ?? 0;
    if(js.model_id){ modelIdEl.textContent = js.model_id; setDownload(js.model_id); }
    if(['finished','failed','canceled','error'].includes((js.status||'').toLowerCase())){
      if(jobTimer) clearInterval(jobTimer);
    }
  }catch(err){ console.error(err); }
}

async function testModel(){
  const mid = modelIdEl.textContent.trim();
  if(!mid || mid==='-') return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ model_id');
  const up = testInput.files ? Array.from(testInput.files) : [];
  if(!up.length) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
  const fd = new FormData(); up.forEach(f=> fd.append('files', f, f.name));
  btnTest.disabled = true; testMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‚Ä¶';
  try{
    const res = await fetch(`${API_BASE}/models/${encodeURIComponent(mid)}/test`, { method:'POST', body: fd });
    const js  = await res.json();
    if(!res.ok) throw new Error(js.detail||res.statusText);
    renderTestResults(js.items);
    testMsg.textContent = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${js.items.length} ‡∏£‡∏π‡∏õ`;
  }catch(err){
    console.error(err);
    testMsg.textContent = '‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message;
    alert('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
  }finally{ btnTest.disabled = false; }
}

function renderTestResults(items){
  testResults.innerHTML = '';
  if(!items || !items.length){
    testResults.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>';
    return;
  }
  items.forEach(it=>{
    const div = document.createElement('div');
    div.className = 'result';
    const imgUrl = toStaticUrl(it.result_image) || toStaticUrl(it.heatmap_image);
    const badge = it.is_anomaly
      ? '<span class="badge bad">ANOMALY</span>'
      : '<span class="badge ok">NORMAL</span>';
    div.innerHTML = `
      <img src="${imgUrl || ''}" alt="">
      <div class="meta">
        <div>${badge} <strong>${it.filename}</strong></div>
        <div>score: ${Number(it.score||0).toFixed(4)} ‚Ä¢ thr: ${Number(it.threshold||0).toFixed(4)}</div>
        ${imgUrl ? `<a class="dl" href="${imgUrl}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</a>` : ''}
      </div>`;
    testResults.appendChild(div);
  });
}

/* ===================== EVENTS ===================== */
fileInput.addEventListener('change', (e)=>{ files = Array.from(e.target.files||[]); updateThumbs(); });
drop.addEventListener('drop', (e)=>{ e.preventDefault(); files = files.concat(Array.from(e.dataTransfer.files||[])); updateThumbs(); });
btnClear.onclick = ()=>{ files=[]; updateThumbs(); };

canvas.addEventListener('click', (e)=>{
  if(!canvas.__imgMeta || closed) return;

  const rect = canvas.getBoundingClientRect();
  // ‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏à‡∏≠ ‚Üí ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™
  const scaleX = canvas.width  / rect.width;
  const scaleY = canvas.height / rect.height;
  const cx = (e.clientX - rect.left) * scaleX;
  const cy = (e.clientY - rect.top)  * scaleY;

  const m = canvas.__imgMeta;
  if(cx<m.x||cy<m.y||cx>m.x+m.w||cy>m.y+m.h) return;

  const ix = Math.round((cx - m.x)/m.w * m.origW);
  const iy = Math.round((cy - m.y)/m.h * m.origH);
  points.push({x:ix,y:iy});
  draw();
});
canvas.addEventListener('dblclick', ()=>{ if(points.length>=3){ closed=true; draw(); } });

btnClearRoi.onclick = ()=>{ points.length=0; closed=false; draw(); roiMsg.textContent=''; };

btnSaveRoi.onclick = async ()=>{
  if (inProject) {
    alert('ROI ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î Scene ‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
    return;
  }
  const scene = sceneId.value.trim();
  if(!scene) return alert('‡∏Å‡∏£‡∏≠‡∏Å Scene ID ‡∏Å‡πà‡∏≠‡∏ô');
  if(points.length<3 || !closed) return alert('‡∏ß‡∏≤‡∏î‡πÇ‡∏û‡∏•‡∏¥‡∏Å‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô');
  const m = canvas.__imgMeta; if(!m) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á');
  const payload = { image_size:[m.origH, m.origW], polygon: points.map(p=>[p.x,p.y]) };
  roiMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ROI...';
  try{
    const res = await fetch(`${API_BASE}/scenes/${encodeURIComponent(scene)}/roi`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
    });
    if(!res.ok) throw new Error(await res.text());
    roiMsg.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ROI ‡πÅ‡∏•‡πâ‡∏ß';
    dbg.textContent = JSON.stringify(payload, null, 2);
  }catch(err){
    roiMsg.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; console.error(err);
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ROI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
  }
};

btnUpload.onclick = uploadFiles;
btnTrain.onclick  = startTrain;
btnPoll.onclick   = pollStatus;
btnTest.onclick   = testModel;

/* ===================== BOOT ===================== */
window.addEventListener('load', ()=>{
  if (inProject) {
    // ‡∏õ‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏á Scene ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏ö‡∏™‡∏ô ‡πÅ‡∏•‡∏∞‡∏ö‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î
    sceneId.value = `(project) ${projectId}`;
    sceneId.disabled = true;
    // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° ROI ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ ROI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå)
    btnSaveRoi.disabled = true;
    btnClearRoi.disabled = true;
  } else {
    // demo scene id ‡πÄ‡∏î‡∏¥‡∏°
    sceneId.value = 'cam_park_01';
  }
  loadInitialImages();
});

// ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Projects
document.getElementById('btnBack').onclick = () => {
  // ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
  window.location.href = '/ui/projects.html';
};


const back = document.getElementById('btnBack');
if (back) back.onclick = () => { window.location.href = '/ui/projects.html'; };

function syncCanvasDPR() {
  const rect = canvas.getBoundingClientRect();         // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà "‡πÅ‡∏™‡∏î‡∏á" ‡∏ö‡∏ô‡∏à‡∏≠ (CSS px)
  const dpr  = window.devicePixelRatio || 1;

  // style size = ‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
  canvas.style.width  = rect.width + 'px';
  canvas.style.height = rect.height + 'px';

  // backing-store size = CSS * DPR  (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏° ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î 1:1 ‡∏Å‡∏±‡∏ö CSS)
  canvas.width  = Math.round(rect.width  * dpr);
  canvas.height = Math.round(rect.height * dpr);

  // scale context ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "CSS space" ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å ctx.*
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener('resize', syncCanvasDPR);
window.addEventListener('load',   syncCanvasDPR);
</script>

</body>
</html>
